---
- name: Join Ubuntu VM to Windows AD
  hosts: all
  vars:
    domain_admin_password: Login@786
  
  tasks:
    - name: Create connection file
      copy:
        dest: /etc/NetworkManager/system-connections/eth0.nmconnection
        content: |
          [connection]
          id=eth0
          type=ethernet
          autoconnect=true

          [ipv4]
          method=manual
          addresses=192.0.2.100/24
          gateway=192.0.2.1
          dns=8.8.8.8;192.168.4.150;
          dns-search=uat-cluster.local

    - name: Restart NetworkManager
      systemd:
        state: restarted
        name: NetworkManager
        
    - name: Install required packages
      apt:
        name: "{{ item }}"
        state: present
      with_items:
        - realmd
        - sssd
        - sssd-tools
        - adcli
        - krb5-user

    - name: Join the AD domain
      become: yes
      become_user: root
      become_method: sudo
      shell: "realm -v join uat-cluster.local"
      args:
        stdin: Login@786
      # Be cautious with storing passwords in playbooks. You might want to use Ansible Vault to securely manage secrets.

    - name: Configure SSSD
      template:
        src: sssd.conf.j2
        dest: /etc/sssd/sssd.conf
      notify:
        - restart sssd

  handlers:
    - name: restart sssd
      service:
        name: sssd
        state: restarted
